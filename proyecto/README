# Proyecto Geoinformática (PEP) – Stack Docker (PostGIS + Jupyter + Streamlit + OTP)

Este repositorio se levanta con **Docker Compose** e incluye:

- **PostGIS** (BD espacial)
- **JupyterLab** (notebooks)
- **Streamlit** (app web)
- **OpenTripPlanner (OTP)** (accesibilidad / transporte público)

> OTP ya está incluido en `docker-compose.yml`. No necesitas instalar OTP local.

---

## 0) Requisitos

- Docker + Docker Compose v2 (`docker compose ...`)
- Puertos libres: **5432** (PostGIS), **8888** (Jupyter), **8501** (Streamlit), **8080** (OTP), **5050** (pgAdmin)
- (Opcional) QGIS para visualizar el GeoPackage.

---

## 1) Estructura de carpetas importante

- `notebooks/` notebooks del proyecto (monta en `/home/jovyan/work`)
- `data/` datos del proyecto (monta en `/home/jovyan/data`)
- `outputs/` salidas (CSV/Parquet/figuras) (monta en `/home/jovyan/outputs`)
- `app/` aplicación Streamlit (monta en `/home/jovyan/app`)
- `data/otp/` insumos y grafo de OTP (persistente)

---

## 2) Variables de entorno (`.env`)

Crea/asegura un archivo `.env` en la raíz del repo.

Ejemplo mínimo:

```bash
POSTGRES_DB=pep
POSTGRES_USER=pep
POSTGRES_PASSWORD=pep
POSTGRES_PORT=5432

JUPYTER_PORT=8888
JUPYTER_TOKEN=pep1

## 3) Levantar el proyecto (paso a paso)

### 3.1 Apagar contenedores (si venías de intentos previos)
```bash
docker compose down
```

### 3.2 Reconstruir imágenes (si cambió Dockerfile o requirements)
```bash
docker compose build --no-cache
```

### 3.3 Levantar todos los servicios
```bash
docker compose up -d
```

Verifica que estén corriendo:
```bash
docker ps
```

## 4) OTP (OpenTripPlanner): build del grafo y servicio
En docker-compose.yml existen dos servicios relacionados a OTP:

- otp_build: construye el grafo (build) y lo guarda en ./data/otp/
- otp: carga el grafo y sirve la API en el puerto 8080

### 4.1 ¿Qué debe existir en data/otp/?
Dentro de:
```bash
data/otp/
```
OTP necesita (según tu caso):
- un archivo OSM .pbf
- uno o más GTFS .zip (transporte público)

El nombre exacto no importa: OTP escanea la carpeta.

### 4.2 Construir el grafo (solo cuando corresponde)
Ejecuta el build si:

- es la primera vez,

- cambiaste el .pbf,

- cambiaste el/los GTFS,

- o borraste graph.obj.

Comando recomendado:
```bash
docker compose run --rm otp_build
```

Si quieres ver logs en vivo:
```bash
docker compose up otp_build
```

(ese contenedor termina solo al finalizar el build)

### 4.3 Servir OTP
Una vez construido el grafo:
```bash
docker compose up -d otp
```

Verifica que responde en el host:

- http://localhost:8080

Logs:
```bash
docker logs -f otp_pep
```

### 4.4 URL de OTP dentro de Docker vs host
- Desde tu navegador (host): http://localhost:8080
- Desde Jupyter/Streamlit dentro de contenedor: http://otp:8080

El docker-compose.yml ya define en Jupyter:

- OTP_URL=http://otp:8080

## 5) Acceso a las herramientas
Streamlit
- http://localhost:8501

Logs:
```bash
docker logs -f streamlit_pep
```

JupyterLab

- http://localhost:8888
- Token: el de tu .env (ej. pep1)

Logs:
```bash
docker logs -f jupyter_pep
```

pgAdmin (opcional)

- http://localhost:5050

## 6) Flujo recomendado de notebooks
00_template.py

- define rutas base y crea carpetas de data/ y outputs/

Notebook 01 – Adquisición

- construye/verifica el GeoPackage:

- data/raw/Carga de datos/geodatabase_proyecto.gpkg

Notebook 03 – Accesibilidad (OTP)

- usa OTP para tiempos de viaje

- outputs esperados en outputs/:

- outputs/acc_long_partial.csv

- outputs/comunas_accessibility_otp.parquet

Notebook 04 – Machine Learning

- PCA + clustering

- usar cod_comuna como llave (normalizar CUT_COM -> cod_comuna)

Notebook 05 – Results synthesis

- recalcula “desiertos” y métricas desde el parquet y clusters

## 7) Troubleshooting rápido
Ver contenedores
```bash
docker ps
```

Reiniciar servicios
```bash
docker compose restart otp
docker compose restart jupyter
docker compose restart web
```

OTP da timeout

- aumentar timeout del request en el cliente

- reintentos con backoff + cache

- revisar logs:

```bash
docker logs -f otp_pep
```

Puerto ocupado (ej: 5432)

- cambia POSTGRES_PORT en .env o libera el puerto local

