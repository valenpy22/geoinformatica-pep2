# Proyecto Geoinform√°tica (PEP) ‚Äì Stack Docker (PostGIS + Jupyter + Streamlit + OTP)

Este repositorio se levanta con **Docker Compose** e incluye:

- **PostGIS** (BD espacial)
- **JupyterLab** (notebooks)
- **Streamlit** (app web)
- **OpenTripPlanner (OTP)** (accesibilidad / transporte p√∫blico)

> OTP ya est√° incluido en `docker-compose.yml`. No necesitas instalar OTP local.

---

## 0) Requisitos

- Docker + Docker Compose v2 (`docker compose ...`)
- Git LFS (debe estar instalado y configurado)
- Puertos libres: **5432** (PostGIS), **8888** (Jupyter), **8501** (Streamlit), **8080** (OTP), **5050** (pgAdmin)
- (Opcional) QGIS para visualizar el GeoPackage.

---

## 1) Estructura de carpetas importante

- `notebooks/` notebooks del proyecto (monta en `/home/jovyan/work`)
- `data/` datos del proyecto (monta en `/home/jovyan/data`)
- `outputs/` salidas (CSV/Parquet/figuras) (monta en `/home/jovyan/outputs`)
- `app/` aplicaci√≥n Streamlit (monta en `/home/jovyan/app`)
- `data/otp/` insumos y grafo de OTP (persistente)

---

## 2) Variables de entorno (`.env`)

Crea/asegura un archivo `.env` en la ra√≠z del repo.

Ejemplo m√≠nimo:

```bash
POSTGRES_DB=pep
POSTGRES_USER=pep
POSTGRES_PASSWORD=pep
POSTGRES_PORT=5432

JUPYTER_PORT=8888
JUPYTER_TOKEN=pep1

## 3) Levantar el proyecto (paso a paso)

### 3.1 Apagar contenedores (si ven√≠as de intentos previos)
```bash
docker compose down
```

### 3.2 Reconstruir im√°genes (si cambi√≥ Dockerfile o requirements)
```bash
docker compose build --no-cache
```

### 3.3 Levantar todos los servicios
```bash
docker compose up -d
```

Verifica que est√©n corriendo:
```bash
docker ps
```

## 4) OTP (OpenTripPlanner): build del grafo y servicio
En docker-compose.yml existen dos servicios relacionados a OTP:

- otp_build: construye el grafo (build) y lo guarda en ./data/otp/
- otp: carga el grafo y sirve la API en el puerto 8080

### 4.1 ¬øQu√© debe existir en data/otp/?
Dentro de:
```bash
data/otp/
```
OTP necesita (seg√∫n tu caso):
- un archivo OSM .pbf
- uno o m√°s GTFS .zip (transporte p√∫blico)

El nombre exacto no importa: OTP escanea la carpeta.

### 4.2 Construir el grafo (solo cuando corresponde)
Ejecuta el build si:

- es la primera vez,

- cambiaste el .pbf,

- cambiaste el/los GTFS,

- o borraste graph.obj.

Comando recomendado:
```bash
docker compose run --rm otp_build
```

Si quieres ver logs en vivo:
```bash
docker compose up otp_build
```

(ese contenedor termina solo al finalizar el build)

### 4.3 Servir OTP
Una vez construido el grafo:
```bash
docker compose up -d otp
```

Verifica que responde en el host:

- http://localhost:8080

Logs:
```bash
docker logs -f otp_pep
```

### 4.4 URL de OTP dentro de Docker vs host
- Desde tu navegador (host): http://localhost:8080
- Desde Jupyter/Streamlit dentro de contenedor: http://otp:8080

El docker-compose.yml ya define en Jupyter:

- OTP_URL=http://otp:8080

## 5) Acceso a las herramientas
Streamlit
- http://localhost:8501

Logs:
```bash
docker logs -f streamlit_pep
```

JupyterLab

- http://localhost:8888
- Token: el de tu .env (ej. pep1)

Logs:
```bash
docker logs -f jupyter_pep
```

pgAdmin (opcional)

- http://localhost:5050

## 6) Flujo recomendado de notebooks
00_template.py

- define rutas base y crea carpetas de data/ y outputs/

Notebook 01 ‚Äì Adquisici√≥n

- construye/verifica el GeoPackage:

- data/raw/Carga de datos/geodatabase_proyecto.gpkg

Notebook 03 ‚Äì Accesibilidad (OTP)

- usa OTP para tiempos de viaje

- outputs esperados en outputs/:

- outputs/acc_long_partial.csv

- outputs/comunas_accessibility_otp.parquet

Notebook 04 ‚Äì Machine Learning

- PCA + clustering

- usar cod_comuna como llave (normalizar CUT_COM -> cod_comuna)

 Notebook 05 ‚Äì Results synthesis

 - recalcula "desiertos" y m√©tricas desde el parquet y clusters

 Notebook 06 ‚Äì Backend Calculator

 - desarrollo y pruebas de la calculadora de calidad de vida

 ## 6) Calculadora de Calidad de Vida

 La aplicaci√≥n incluye una **calculadora de calidad de vida** accesible en la interfaz Streamlit.

 ### C√≥mo Usar la Calculadora

 1. **Accede a la aplicaci√≥n**: Ve a http://localhost:8501 en tu navegador.

 2. **Navega a la pesta√±a**: Selecciona la pesta√±a "Calculadora de Calidad de Vida".

 3. **Configura el c√°lculo**:
    - **Selecciona un perfil**: Elige entre "Estudiante", "Adulto Mayor" o "Familia Joven". Cada perfil tiene prioridades diferentes basadas en servicios relevantes.
    - **Ingresa coordenadas**: Proporciona la latitud y longitud de la ubicaci√≥n deseada. Puedes usar inputs num√©ricos o hacer clic en el mapa para seleccionar una posici√≥n.

 4. **Interacci√≥n con el mapa**:
    - El mapa muestra la ubicaci√≥n seleccionada con un marcador rojo.
    - Se dibuja un c√≠rculo azul de 1 km de radio para visualizar el √°rea de an√°lisis.
    - Despu√©s de calcular, se muestran los servicios m√°s cercanos si faltan algunos en el radio.

 5. **Calcula el √≠ndice**: Presiona el bot√≥n "üöÄ Calcular √çndice" para obtener el resultado.

 ### C√≥mo se Calcula el Puntaje

 El √≠ndice de calidad de vida (0-100) se calcula de la siguiente manera:

 - **Radio de an√°lisis**: Se eval√∫an los servicios dentro de un radio de 1000 metros alrededor de la ubicaci√≥n seleccionada.

 - **Perfiles de usuario**: Cada perfil asigna pesos diferentes a los servicios, reflejando prioridades espec√≠ficas:
   - **Estudiante**: Prioriza educaci√≥n superior, transporte p√∫blico, bancos, etc.
   - **Adulto Mayor**: Enfocado en salud, farmacias, √°reas verdes, seguridad.
   - **Familia Joven**: Colegios, parques, supermercados, seguridad.

 - **Normalizaci√≥n y ponderaci√≥n**:
   - Para cada servicio, se cuenta la cantidad disponible en el radio.
   - El conteo se normaliza a un puntaje entre 0 y 1 (basado en rangos t√≠picos).
   - Se multiplica por el peso del perfil para obtener el aporte.
   - Se suman todos los aportes ponderados y se dividen por la suma de pesos m√°ximos, luego se multiplica por 100 para obtener el √≠ndice final.

 - **Resultado**: Un puntaje alto indica una ubicaci√≥n √≥ptima para el perfil seleccionado, considerando accesibilidad a servicios esenciales.

 Los detalles del c√°lculo (conteo, puntaje normalizado, importancia, aporte) se muestran para cada servicio.

 ## 7) Troubleshooting r√°pido
Ver contenedores
```bash
docker ps
```

Reiniciar servicios
```bash
docker compose restart otp
docker compose restart jupyter
docker compose restart web
```

OTP da timeout

- aumentar timeout del request en el cliente

- reintentos con backoff + cache

- revisar logs:

```bash
docker logs -f otp_pep
```

Puerto ocupado (ej: 5432)

- cambia POSTGRES_PORT en .env o libera el puerto local

